{% extends "admin/reports/report_layout.html" %}

{% set title = "Average Flight Occupancy" %}
{% set date = "JAN 2026" %}

{% block report_content %}
<div class="mb-5 border-start border-4 border-primary ps-4">
    <h5 class="text-uppercase text-primary fw-bold small">Executive Summary</h5>
    <p class="text-muted">
        This report analyzes the occupancy rates of the last 5 completed flights. The goal is to identify
        underperforming routes.
        A low occupancy rate (below 70%) may indicate a need to adjust pricing or flight frequency.
        Currently, the red line represents full capacity (100%), allowing for quick visual assessment of flight
        efficiency.
    </p>
</div>

<div class="card bg-light border-0 p-4" style="border-radius: 12px;">
    <h6 class="text-center mb-4">Average Occupancy per Completed Flight</h6>
    <div style="height: 450px;">
        <canvas id="occupancyChart"></canvas>
    </div>
</div>

<div class="row mt-5">
    <div class="col-md-3">
        <small class="text-uppercase text-muted fw-bold" style="font-size: 0.75rem;">Status</small>
        <div class="d-flex align-items-center mt-1">
            <span class="badge bg-success rounded-circle p-1 me-2"> </span>
            <span class="fw-bold text-success">Finalized</span>
        </div>
    </div>
    <div class="col-md-3">
        <small class="text-uppercase text-muted fw-bold" style="font-size: 0.75rem;">Source</small>
        <div class="fw-bold text-dark mt-1 fst-italic">Live Database</div>
    </div>
    <div class="col-md-3">
        <small class="text-uppercase text-muted fw-bold" style="font-size: 0.75rem;">Generated By</small>
        <div class="fw-bold text-dark mt-1">FLYTAU Admin</div>
    </div>
    <div class="col-md-3">
        <small class="text-uppercase text-muted fw-bold" style="font-size: 0.75rem;">Format</small>
        <div class="fw-bold text-dark mt-1">High Fidelity</div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Process Data
        const rawData = {{ recent_data | tojson
    }};

    // Format Labels: "TLV-JFK (15/01/2026 03:00)"
    const labels = rawData.map(item => {
        const dateObj = new Date(item.departure_time);
        // Format: DD/MM/YYYY HH:MM
        const dateStr = dateObj.toLocaleDateString('en-GB') + ' ' +
            dateObj.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        return [item.origin_airport + '-' + item.destination_airport, '(' + dateStr + ')'];
    });

    const values = rawData.map(item => item.occupancy_rate);

    const ctx = document.getElementById('occupancyChart').getContext('2d');

    // Custom Plugin to draw 100% dashed line if Chart.js annotation plugin isn't available
    // Actually, we can just add a dataset of all 100s.
    const capacityLine = new Array(values.length).fill(100);

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    type: 'line',
                    label: 'Full Capacity (100%)',
                    data: capacityLine,
                    borderColor: '#ef4444', // Red-500
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false,
                    order: 1
                },
                {
                    type: 'bar',
                    label: 'Occupancy %',
                    data: values,
                    backgroundColor: '#14b8a6', // Teal-500
                    hoverBackgroundColor: '#0f766e',
                    borderRadius: 4,
                    barPercentage: 0.6,
                    order: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 110, // Little headroom
                    title: {
                        display: true,
                        text: 'Occupancy Percentage (%)'
                    }
                },
                x: {
                    grid: { display: false }
                }
            },
            plugins: {
                legend: {
                    position: 'bottom', // Move legend to right (inside chart area requires more complex config, bottom is cleaner)
                    align: 'end',
                    labels: { usePointStyle: true, boxWidth: 8 }
                },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            return context.dataset.label + ': ' + context.parsed.y + '%';
                        }
                    }
                }
            }
        }
    });
        });
</script>
{% endblock %}