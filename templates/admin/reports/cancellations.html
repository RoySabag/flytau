{% extends "admin/reports/report_layout.html" %}

{% set title = "Cancellation Rate by Month" %}
{% set date = "JAN 2026" %}

{% block report_content %}

<div class="card bg-white border shadow-sm p-4" style="border-radius: 15px;">
    <h6 class="text-center mb-4 text-dark">Customer Cancellation Rate by Month</h6>
    <div style="height: 500px;">
        <canvas id="cancellationChart"></canvas>
    </div>
</div>

<!-- Metadata Footer -->
<div class="row mt-5">
    <div class="col-md-3">
        <small class="text-uppercase text-muted fw-bold" style="font-size: 0.75rem;">Status</small>
        <div class="d-flex align-items-center mt-1">
            <span class="badge bg-success rounded-circle p-1 me-2"> </span>
            <span class="fw-bold text-success">Finalized</span>
        </div>
    </div>
    <div class="col-md-3">
        <small class="text-uppercase text-muted fw-bold" style="font-size: 0.75rem;">Source</small>
        <div class="fw-bold text-dark mt-1 fst-italic">Live Database</div>
    </div>
    <div class="col-md-3">
        <small class="text-uppercase text-muted fw-bold" style="font-size: 0.75rem;">Generated By</small>
        <div class="fw-bold text-dark mt-1">FLYTAU Admin</div>
    </div>
    <div class="col-md-3">
        <small class="text-uppercase text-muted fw-bold" style="font-size: 0.75rem;">Format</small>
        <div class="fw-bold text-dark mt-1">High Fidelity</div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const rawData = {{ cancel_rates | tojson
    }};
    const months = rawData.map(x => x.month);
    const rates = rawData.map(x => x.cancellation_rate);

    const ctx = document.getElementById('cancellationChart').getContext('2d');

    new Chart(ctx, {
        type: 'bar', // Switched to Bar per request
        data: {
            labels: months,
            datasets: [{
                label: 'Cancellation Rate (%)',
                data: rates,
                backgroundColor: '#ef4444', // Red-500 matching image
                borderRadius: 4,
                barPercentage: 0.6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 120, // Add headroom for labels
                    title: {
                        display: true,
                        text: 'Cancellation Rate (%)'
                    },
                    grid: {
                        borderDash: [2, 2]
                    }
                },
                x: {
                    grid: { display: false },
                    ticks: {
                        autoSkip: false,
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                    align: 'end',
                    labels: { usePointStyle: true, boxWidth: 10 }
                },
                // We can't guarantee DataLabels plugin is loaded, but we can configure it just in case,
                // or use animation onComplete to draw text (complex). 
                // For this task, standard tooltips are the safe fallback.
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            return context.dataset.label + ': ' + context.parsed.y + '%';
                        }
                    }
                }
            }
        }
    });
        });
</script>
{% endblock %}