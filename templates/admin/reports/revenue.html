{% extends "admin/reports/report_layout.html" %}

{% set title = "Total Revenue Analysis" %}
{% set date = "JAN 2026" %}

{% block report_content %}

<div class="card bg-white border shadow-sm p-4" style="border-radius: 15px;">
    <h6 class="text-center mb-4 text-dark">Total Revenue by Plane Size, Manufacturer & Class</h6>
    <div style="height: 500px;">
        <canvas id="revenueChart"></canvas>
    </div>
</div>

<!-- Metadata Footer -->
<div class="row mt-5">
    <div class="col-md-3">
        <small class="text-uppercase text-muted fw-bold" style="font-size: 0.75rem;">Status</small>
        <div class="d-flex align-items-center mt-1">
            <span class="badge bg-success rounded-circle p-1 me-2"> </span>
            <span class="fw-bold text-success">Finalized</span>
        </div>
    </div>
    <div class="col-md-3">
        <small class="text-uppercase text-muted fw-bold" style="font-size: 0.75rem;">Source</small>
        <div class="fw-bold text-dark mt-1 fst-italic">Live Database</div>
    </div>
    <div class="col-md-3">
        <small class="text-uppercase text-muted fw-bold" style="font-size: 0.75rem;">Generated By</small>
        <div class="fw-bold text-dark mt-1">FLYTAU Admin</div>
    </div>
    <div class="col-md-3">
        <small class="text-uppercase text-muted fw-bold" style="font-size: 0.75rem;">Format</small>
        <div class="fw-bold text-dark mt-1">High Fidelity</div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const rawData = {{ rev_by_manufacturer | tojson
    }};

    const labels = rawData.map(item => item.label);
    const values = rawData.map(item => item.total_revenue);
    const manufacturers = rawData.map(item => item.manufacturer);

    // Color palette mapping
    const getColor = (mfg) => {
        const lower = mfg.toLowerCase();
        if (lower.includes('boeing')) return '#3b82f6'; // Blue
        if (lower.includes('airbus')) return '#b91c1c'; // Red
        if (lower.includes('dassault')) return '#22c55e'; // Green
        return '#64748b'; // Slate (Default)
    };

    const bgColors = manufacturers.map(m => getColor(m));

    const ctx = document.getElementById('revenueChart').getContext('2d');

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Total Revenue',
                data: values,
                backgroundColor: bgColors,
                borderRadius: 4,
                barPercentage: 0.7
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        borderDash: [2, 2],
                        color: '#e5e7eb'
                    },
                    title: {
                        display: true,
                        text: 'Total Revenue'
                    }
                },
                x: {
                    grid: { display: false },
                    ticks: {
                        autoSkip: false,
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            plugins: {
                legend: { display: false },
                datalabels: { // Note: DataLabels plugin might not be loaded, assuming generic Chart.js
                    display: true,
                    anchor: 'end',
                    align: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed.y);
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });
        });
</script>
{% endblock %}