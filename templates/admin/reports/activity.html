{% extends "admin/reports/report_layout.html" %}

{% set title = "Aircraft Activity Summary" %}
{% set date = "JAN 2026" %}

{% block report_content %}
<div class="mb-5 border-start border-4 border-info ps-4" style="border-color: #0d9488 !important;">
    <h5 class="text-uppercase fw-bold small" style="color: #0d9488;">Executive Summary</h5>
    <p class="text-muted">
        This report summarizes fleet efficiency over the last 30 days.
        The <strong>Grey Bars</strong> show the total completed flights, while the
        <strong>Red Line</strong> tracks the aircraft utilization rate (percentage of time spent in the air).
        The dominant route for each aircraft is listed (hover to view). Low utilization may indicate maintenance issues
        or inefficient scheduling.
    </p>
</div>

<div class="card bg-light border-0 p-4" style="border-radius: 12px;">
    <h6 class="text-center mb-4">Aircraft Activity: Flights vs. Utilization (Last 30 Days)</h6>
    <div style="height: 500px;">
        <canvas id="activityChart"></canvas>
    </div>
</div>

<!-- Metadata Footer -->
<div class="row mt-5">
    <div class="col-md-3">
        <small class="text-uppercase text-muted fw-bold" style="font-size: 0.75rem;">Status</small>
        <div class="d-flex align-items-center mt-1">
            <span class="badge bg-success rounded-circle p-1 me-2"> </span>
            <span class="fw-bold text-success">Finalized</span>
        </div>
    </div>
    <div class="col-md-3">
        <small class="text-uppercase text-muted fw-bold" style="font-size: 0.75rem;">Source</small>
        <div class="fw-bold text-dark mt-1 fst-italic">Live Database</div>
    </div>
    <div class="col-md-3">
        <small class="text-uppercase text-muted fw-bold" style="font-size: 0.75rem;">Generated By</small>
        <div class="fw-bold text-dark mt-1">FLYTAU Admin</div>
    </div>
    <div class="col-md-3">
        <small class="text-uppercase text-muted fw-bold" style="font-size: 0.75rem;">Format</small>
        <div class="fw-bold text-dark mt-1">High Fidelity</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const rawData = {{ aircraft_activity | tojson
    }};

    const labels = rawData.map(x => x.label);
    const flights = rawData.map(x => x.flights_count);
    const utilization = rawData.map(x => x.utilization);
    const routes = rawData.map(x => x.dominant_route);

    // Check if Chart is defined (it should be if super() loaded correctly)
    if (typeof Chart === 'undefined') {
        console.error("Chart.js not loaded!");
        return;
    }

    Chart.register(ChartDataLabels);

    const ctx = document.getElementById('activityChart').getContext('2d');

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Utilization (%)',
                    data: utilization,
                    type: 'line',
                    borderColor: '#ef4444', // Red
                    backgroundColor: '#ef4444',
                    borderWidth: 2,
                    pointRadius: 4,
                    yAxisID: 'y1',
                    datalabels: { display: false } // No labels on line points
                },
                {
                    label: 'Number of Flights',
                    data: flights,
                    backgroundColor: '#cbd5e1', // Slate-300 (Grey)
                    borderRadius: 2,
                    yAxisID: 'y',
                    // Display dominant route inside bars
                    datalabels: {
                        display: true,
                        color: '#0f172a',
                        anchor: 'center',
                        align: 'center',
                        rotation: -90,
                        formatter: function (value, context) {
                            return routes[context.dataIndex] || '';
                        },
                        font: {
                            weight: 'bold',
                            size: 10
                        }
                    }
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    grid: { display: false },
                    ticks: {
                        font: { size: 10 }
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: { display: true, text: 'Number of Flights' },
                    beginAtZero: true,
                    grid: { borderDash: [2, 2] }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: { display: true, text: 'Utilization (%)', color: '#ef4444' },
                    beginAtZero: true,
                    max: 100,
                    grid: { display: false },
                    ticks: { color: '#ef4444' }
                }
            },
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        footer: function (tooltipItems) {
                            const index = tooltipItems[0].dataIndex;
                            return 'Dominant Route: ' + (routes[index] || 'N/A');
                        }
                    }
                }
            }
        }
    });
    });
</script>
{% endblock %}